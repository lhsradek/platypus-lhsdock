====== Elastic Agent ======
[[start|platypus-lhsdock]] with [[Elasticsearch|E]][[Logstash|L]][[Kibana|K]]

Elastic Agent contains [[beats]], [[fleet-server|Fleet Server]] and [[apm-server|APM Server]].

[[https://github.com/lhsradek/platypus-lhsdock/tree/main/extras/elastic-agent|configuration]]


GET [[https://es01.docker.nginx.local:9200/.ds-logs-elastic_agent*/_search?pretty&q=response=50|.ds-logs-elastic_agent*/_search?q=response=50]]

==== Deb ====

[[https://docker.nginx.local/downloads/elastic-agent-8.4.3-amd64.deb|elastic-agent-8.4.3-amd64.deb]]

==== Linux tar ====

[[https://docker.nginx.local/downloads/elastic-agent-8.4.3-linux-x86_64.tar.gz|elastic-agent-8.4.3-linux-x86_64.tar.gz]]

==== RPM ====

[[https://docker.nginx.local/downloads/elastic-agent-8.4.3-x86_64.rpm|elastic-agent-8.4.3-x86_64.rpm]]

-----

====== Elastic APM agent ======

Elastic APM agent can connect to [[APM-Server|APM server]].

===== Elastic APM agent jar =====

Elastic APM agent jar is from https://mvnrepository.com/artifact/co.elastic.apm/elastic-apm-agent

[[https://docker.nginx.local/downloads/elastic-apm-agent-1.34.1.jar|elastic-apm-agent-1.34.1.jar]]

===== Elastic APM agent php =====

Elastic APM agent php is from https://github.com/elastic/apm-agent-php

https://www.elastic.co/guide/en/apm/agent/php/current/intro.html

https://www.elastic.co/guide/en/apm/agent/php/current/configuration-reference.html

With this part in [[https://github.com/lhsradek/platypus-lhsdock/blob/main/docker-compose.local.yml|docker-compose.yml]]:
<code yaml>
  weblhs-php:
    # Alpine Linux
    # image: php:fpm-alpine
    image: lhsradek/fpm:v1
    restart: ${DOCKER_RESTART_POLICY}
    container_name: "${APP_ID}-php"
    hostname: "weblhs-php.${INT_NETWORK}"
    networks:
      # local network:
      - intnet
    environment:
      - APP_ID=${APP_ID}
      - APP_HOST=${APP_HOST}
      - APP_NET=${INT_NETWORK}
      - CLUSTER_NAME=${CLUSTER_NAME}
      - CLUSTER_UUID=${CLUSTER_UUID}
      - ELASTIC_APM_ENVIRONMENT=${STAGE}
      - ELASTIC_APM_HOSTNAME=weblhs-php.${INT_NETWORK}
      - ELASTIC_APM_LOG_LEVEL_STDERR=info
      - ELASTIC_APM_SECRET_TOKEN=${ELASTIC_APM_SECRET_TOKEN}
      - ELASTIC_APM_SERVER_URL=http://apm.${INT_NETWORK}:8200
      - ELASTIC_APM_SERVICE_NAME=${APP_ID}
      - ELASTIC_APM_SERVICE_NODE_NAME=${APP_HOST}.${INT_NETWORK}
    volumes:
      - ./application/html:/var/www/html:ro
</code>

You can see in:

=== phpInfo(); ===

{{elastic-apm-php.png?300x300}}

=== Kibana - Observability - APM - Services ===

{{kibana10.png?600x200}}

See the ElasticApm transaction in [[index.php]] inside methodhs IndexController.**isSocket** and IndexController.**isUrl**.


==== Deb ====

[[https://docker.nginx.local/downloads/apm-agent-php_1.6.1_all.deb|apm-agent-php_1.6.1_all.deb]]

==== Alpine ====

[[https://docker.nginx.local/downloads/apm-agent-php_1.6.1_all.apk|apm-agent-php_1.6.1_all.apk]]

Web is [[https://hub.docker.com/_/nginx|alpine nginx]] with [[https://hub.docker.com/_/php|fpm-alpine]] and [[https://github.com/lhsradek/platypus-lhsfpm/blob/main/context/Dockerfile|lhsradek/fpm:v1]] with:
<code>
ADD --chown=55 /root/bin/apm-agent-php_1.6.1_all.apk /root/bin/apm-agent-php_1.6.1_all.apk
RUN apk add --allow-untrusted --no-cache /root/bin/apm-agent-php_1.6.1_all.apk
RUN rm -f /root/bin/apm-agent-php_1.6.1_all.apk
</code>

==== RPM ====

[[https://docker.nginx.local/downloads/apm-agent-php-1.6.1-1.noarch.rpm|apm-agent-php-1.6.1-1.noarch.rpm]]

<code bash>
[root@docker ~]# dnf -y install https://docker.nginx.local/downloads/apm-agent-php-1.6.1-1.noarch.rpm --setopt sslverify=0
Poslední kontrola metadat: před 0:52:20, Čt 13. října 2022, 15:42:29.
apm-agent-php-1.6.1-1.noarch.rpm                                                                           2.9 MB/s | 1.0 MB     00:00    
Závislosti vyřešeny.
===========================================================================================================================================
 Balíček                             Architektura                 Verze                           Repozitář                        Velikost
===========================================================================================================================================
Instalování:
 apm-agent-php                       noarch                       1.6.1-1                         @commandline                       1.0 M

Shrnutí transakce
===========================================================================================================================================
Instalovat  1 balíček

Celková velikost: 1.0 M
Velikost po nainstalování: 4.5 M
Stahování balíčků:
Spouští se kontrola transakce
Kontrola transakce byla úspěšná
Probíhá test transakce
Test transakce byl úspěšný.
Transakce probíhá
  Příprava        :                                                                                                                    1/1 
  Instalování     : apm-agent-php-1.6.1-1.noarch                                                                                       1/1 
  Probíhá skriplet: apm-agent-php-1.6.1-1.noarch                                                                                       1/1 
Installing Elastic PHP agent
  Ověřuje se      : apm-agent-php-1.6.1-1.noarch                                                                                       1/1 

Nainstalováno:
  apm-agent-php-1.6.1-1.noarch                                                                                                             

Hotovo!
</code>

-----
