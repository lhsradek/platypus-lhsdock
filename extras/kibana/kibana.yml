# Kibana configuration for docker target

server:
  host: "0.0.0.0"
  shutdownTimeout: "5s"
  socketTimeout: "240000"
  publicBaseUrl: "https://kibana.${APP_HOST}.${APP_NET}:5601"
  ssl:
    enabled: true
    certificateAuthorities: ["${ELASTICSEARCH_SSL_CERTIFICATEAUTHORITIES}"]
    certificate: "${ELASTICSEARCH_SSL_SERVER_CERT}" 
    key: "${ELASTICSEARCH_SSL_SERVER_CERT_KEY}"
      
monitoring:
  ui:
    enabled: true
    container:
      elasticsearch.enabled: true
      logstash.enabled: true
    ccs.enabled: false
    elasticsearch:
      hosts: 
        - "https://es01.${APP_HOST}.${APP_NET}:9200"
        - "https://es02.${APP_HOST}.${APP_NET}:9201"
        # - "https://es03.${APP_HOST}.${APP_NET}:9202"
      username: "${ELASTICSEARCH_USERNAME}"
      password: "${ELASTICSEARCH_PASSWORD}"
      ssl.certificateAuthorities: ["${ELASTICSEARCH_SSL_CERTIFICATEAUTHORITIES}"]
      requestTimeout: 240000
  # https://www.elastic.co/guide/en/kibana/master/monitoring-settings-kb.html
  # https://www.elastic.co/guide/en/kibana/master/monitoring-metricbeat.html
  # https://www.elastic.co/guide/en/kibana/master/monitor-troubleshooting.html
  kibana.collection.enabled: false

# https://www.elastic.co/guide/en/kibana/current/settings.html#elasticsearch-ssl-cert-key
elasticsearch:
  hosts: 
    - "https://es01.${APP_HOST}.${APP_NET}:9200"
    # - "https://es02.${APP_HOST}.${APP_NET}:9201"
    # - "https://es03.${APP_HOST}.${APP_NET}:9202"
  username: "${ELASTICSEARCH_USERNAME}"
  password: "${ELASTICSEARCH_PASSWORD}"
  ssl.certificateAuthorities: ["${ELASTICSEARCH_SSL_CERTIFICATEAUTHORITIES}"]
  requestTimeout: 240000

enterpriseSearch:
  host: "http://eps.${APP_NET}:3002"
  accessCheckTimeout: 60000

xpack:
  reporting:
    kibanaServer.hostname: "kibana"
    roles.enabled: false
    encryptionKey: 8de551ca1432f0dcf3ad2908472562b1
  security:
    encryptionKey: 363792db7b8cf9581c6cbdddbb8ff95f
    session.idleTimeout: 24h
  encryptedSavedObjects:
    encryptionKey: 97aa4816075f95e8d51bac9159574a19
  task_manager:
    poll_interval: 180000
    max_workers: 2
  apm.serviceMapEnabled: false
  fleet:
    agents:
      # https://www.elastic.co/guide/en/kibana/current/fleet-settings-kb.html
      # https://www.elastic.co/guide/en/fleet/current/secure-connections.html
      # https://www.elastic.co/guide/en/fleet/current/secure-logstash-connections.html
      fleet_server:
        hosts:
          - "https://fleet.${APP_HOST}.${APP_NET}:8220"
          - "https://fleet.www.wordpress.local:8220"
          - "https://fleet.${APP_HOST}.wordpress.local:8220"
          - "https://fleet.www.tomcat.local:8220"
          - "https://fleet.${APP_HOST}.tomcat.local:8220"
      # elasticsearch.hosts: ["https://es01.${APP_HOST}.${APP_NET}:9200"]
      # https://es01.docker.nginx.local:9200
      # Disable previous line after the first Kibana running and add to Fleet - Setings - Outputs
      # cp certs/ca/ca.crt cert/ca.crt - This is so that other elastic agents from other projects can have ca.crt in the cert directory
      # Elasticsearch - Advanced YAML configuration:
      # ssl.certificate_authorities: ["/usr/share/elastic-agent/certs/ca.crt"]
      #
      # See https://www.gooksu.com/2022/05/fleet-server-with-logstash-output-elastic-agent/
      # Set Make this output the default for agent monitoring.
      # to logstash output - Advanced YAML configuration You can optional add:
      # ssl.verification_mode: none

    # https://www.elastic.co/guide/en/fleet/current/create-a-policy-no-ui.html
    packages:
      - name: elastic_agent
        version: latest
      - name: fleet_server
        version: latest
      - name: apm
        version: latest
      - name: system
        version: latest
      - name: docker
        version: latest
      - name: mysql
        version: latest
      - name: nginx
        version: latest
      - name: postgresql
        version: latest
      - name: redis
        version: latest
      - name: tomcat
        version: latest
      - name: traefik
        version: latest
      - name: log
        version: latest
      - name: logstash
        version: latest

    # https://www.elastic.co/guide/en/kibana/current/fleet-settings-kb.html
    # https://www.elastic.co/guide/en/fleet/current/migrate-beats-to-agent.html
    agentPolicies:          
      - name: Agent Nginx policy 1
        description: Agent Nginx policy
        id: agent-nginx-policy-1
        namespace: default
        monitoring_enabled:
          - logs
          - metrics
        package_policies:
          - name: fleet_server_nginx-1
            package:
              name: fleet_server
            description: Fleet Server
            id: fleet_server_nginx-1
          - name: elastic_agent_nginx-1
            package:
              name: elastic_agent
            description: Elastic Agent
            id: elastic_agent_nginx-1
          - name: apm_nginx-1
            package:
              name: apm
            description: Elastic APM
            id: apm_nginx-1
            inputs:
              - type: apm
                keep_enabled: true
                vars:
                  - name: host
                    value: "0.0.0.0:8200"
                  - name: url
                    value: "http://fleet.${APP_HOST}.${APP_NET}:8200"
          - name: docker_nginx-1
            package:
              name: docker
            description: Docker Metrics
            id: docker_nginx-1
            inputs:
              - type: docker/metrics
                enabled: true
                streams:
                  - data_stream:
                      dataset: docker.memory
                    enabled: false
          - name: system_nginx-1
            package:
              name: system
            description: System
            id: system_nginx-1
            inputs:
              - type: logfile
                enabled: true
                streams:
                  - data_stream:
                      dataset: system.syslog
                    enabled: true
                    vars:
                      - name: paths
                        value:
                          - /hostfs/var/log/messages
                          # - /hostfs/var/log/syslog
                  - data_stream:
                      dataset: system.auth
                    enabled: true
                    vars:
                      - name: paths
                        value:
                          - /hostfs/var/log/auth.log
                          - /hostfs/var/log/secure
              - type: system/metrics
                enabled: false
                vars:
                  - name: system.hostfs
                    value: /hostfs
              - type: winlog
                enabled: false
          - name: nginx_nginx-1
            package:
              name: nginx
            description: Nginx
            id: nginx_nginx-1
            inputs:
              - type: logfile
                streams:
                  - data_stream:
                      dataset: nginx.access
                    vars:
                      - name: paths
                        value:
                          - /usr/share/elastic-agent/data/elastic-agent-${STV}/install/filebeat-${STACK_VERSION}-linux-x86_64/elogs/nginx/default/access.log
                          - /usr/share/elastic-agent/data/elastic-agent-${STV}/install/filebeat-${STACK_VERSION}-linux-x86_64/elogs/nginx/default/php-access.log
                          - /usr/share/elastic-agent/data/elastic-agent-${STV}/install/filebeat-${STACK_VERSION}-linux-x86_64/elogs/nginx/dokuwiki/nginx/access.log
                          - /usr/share/elastic-agent/data/elastic-agent-${STV}/install/filebeat-${STACK_VERSION}-linux-x86_64/elogs/nginx/dokuwiki/php/access.log
                  - data_stream:
                      dataset: nginx.error
                    vars:
                      - name: paths
                        value:
                          - /usr/share/elastic-agent/data/elastic-agent-${STV}/install/filebeat-${STACK_VERSION}-linux-x86_64/elogs/nginx/default/error.log
                          - /usr/share/elastic-agent/data/elastic-agent-${STV}/install/filebeat-${STACK_VERSION}-linux-x86_64/elogs/nginx/default/php-error.log
                          - /usr/share/elastic-agent/data/elastic-agent-${STV}/install/filebeat-${STACK_VERSION}-linux-x86_64/elogs/nginx/dokuwiki/nginx/error.log
                          - /usr/share/elastic-agent/data/elastic-agent-${STV}/install/filebeat-${STACK_VERSION}-linux-x86_64/elogs/nginx/dokuwiki/php/error.log
              - type: nginx/metrics
                enabled: true
                vars:
                  - name: hosts
                    value:
                      # to existing servers:
                      - http://${APP_HOST}.${APP_NET} 
                      - http://wiki.${APP_HOST}.${APP_NET} 
                      # to services:
                      # - http://weblhs
                      # - http://weblhs-wiki
          - name: traefik_nginx-1
            package:
              name: traefik
            description: Traefik
            id: traefik_nginx-1
            inputs:
              - type: logfile
                enabled: true
                streams:
                  - data_stream:
                      dataset: traefik.access
                    keep_enabled: true
                    enabled: true
                    vars:
                      - name: paths
                        value:
                          - /usr/share/elastic-agent/data/elastic-agent-${STV}/install/filebeat-${STACK_VERSION}-linux-x86_64/elogs/traefik/access.json
                          # - /usr/share/elastic-agent/data/elastic-agent-${STV}/install/filebeat-${STACK_VERSION}-linux-x86_64/elogs/traefik/traefik.json
              - type: traefik/metrics
                enabled: false
          - name: logstash_nginx-1
            package:
              name: logstash
            description: Logstash
            id: logstash_nginx-1
            inputs:
              - type: logfile
                enabled: false
              - type: logstash/metrics
                enabled: true
                vars:
                  - name: hosts
                    value:
                      - http://logstash.${APP_HOST}.${APP_NET}:9600 
          - name: log_nginx-1
            package:
              name: log
            description: Custom Logs
            id: log_nginx-1
            inputs:
              - type: logfile
                streams:
                  - data_stream:
                      dataset: log.log
                    vars:
                      - name: paths
                        value:
                          - /usr/share/elastic-agent/data/elastic-agent-${STV}/install/filebeat-${STACK_VERSION}-linux-x86_64/elogs/kibana/kibana.log
                      - name: data_stream.dataset
                        value: kibana.log
             
      - name: Agent Wordpress policy 1
        description: Agent Wordpress policy
        id: agent-wordpress-policy-1
        namespace: default
        monitoring_enabled:
          - logs
          - metrics
        package_policies:
          - name: fleet_server_wordpress-1
            description: Fleet Server
            id: fleet_server_wordpress-1
            package:
              name: fleet_server
          - name: elastic_agent_wordpress-1
            description: Elastic Agent
            id: elastic_agent_wordpress-1
            package:
              name: elastic_agent
          - name: apm_wordpress-1
            description: Elastic APM
            id: apm_wordpress-1
            package:
              name: apm
            inputs:
              - type: apm
                keep_enabled: true
                vars:
                  - name: host
                    value: "0.0.0.0:8200"
                  - name: url
                    value: "http://fleet:8200"
                    # value: "http://fleet.${APP_HOST}.wordpress.local:8200"
          - name: system_wordpress-1
            description: System Integration
            id: system_wordpress-1
            package:
              name: system
            inputs:
              - type: logfile
                enabled: false
                streams:
                  - data_stream:
                      dataset: system.syslog
                    enabled: true
                    vars:
                      - name: paths
                        value:
                          - /hostfs/var/log/messages
                          - /hostfs/var/log/syslog
                  - data_stream:
                      dataset: system.auth
                    enabled: true
                    vars:
                      - name: paths
                        value:
                          - /hostfs/var/log/auth.log
                          - /hostfs/var/log/secure
              - type: system/metrics
                enabled: false
                vars:
                  - name: system.hostfs
                    value: /hostfs
                streams:
                  - data_stream:
                      dataset: system.core
                    enabled: true
                    vars:
                      - name: period
                        value: 10s
              - type: winlog
                enabled: false
          - name: nginx_wordpress-1
            package:
              name: nginx
            description: Nginx
            id: nginx_wordpress-1
            inputs:
              - type: logfile
                streams:
                  - data_stream:
                      dataset: nginx.access
                    enabled: true
                    vars:
                      - name: paths
                        value:
                          - /usr/share/elastic-agent/data/elastic-agent-${STV}/install/filebeat-${STACK_VERSION}-linux-x86_64/elogs/nginx/platypus-wordpress-mysql/access.log
                          - /usr/share/elastic-agent/data/elastic-agent-${STV}/install/filebeat-${STACK_VERSION}-linux-x86_64/elogs/nginx/platypus-wordpress-mysql/php-access.log
                          - /usr/share/elastic-agent/data/elastic-agent-${STV}/install/filebeat-${STACK_VERSION}-linux-x86_64/elogs/nginx/platypus-wordpress-mysql/pma.access.log
                          - /usr/share/elastic-agent/data/elastic-agent-${STV}/install/filebeat-${STACK_VERSION}-linux-x86_64/elogs/nginx/platypus-wordpress-mysql/wp.access.log
                  - data_stream:
                      dataset: nginx.error
                    enabled: true
                    vars:
                      - name: paths
                        value:
                          - /usr/share/elastic-agent/data/elastic-agent-${STV}/install/filebeat-${STACK_VERSION}-linux-x86_64/elogs/nginx/platypus-wordpress-mysql/error.log
                          - /usr/share/elastic-agent/data/elastic-agent-${STV}/install/filebeat-${STACK_VERSION}-linux-x86_64/elogs/nginx/platypus-wordpress-mysql/php-error.log
                          - /usr/share/elastic-agent/data/elastic-agent-${STV}/install/filebeat-${STACK_VERSION}-linux-x86_64/elogs/nginx/platypus-wordpress-mysql/pma.error.log
                          - /usr/share/elastic-agent/data/elastic-agent-${STV}/install/filebeat-${STACK_VERSION}-linux-x86_64/elogs/nginx/platypus-wordpress-mysql/wp.error.log
              - type: nginx/metrics
                enabled: true
                vars:
                  - name: hosts
                    value:
                      # to existing server:
                      # - http://${APP_HOST}.wordpress.local 
                      # to service:
                      - http://webwp
          - name: mysql_wordpress-1
            package:
              name: mysql
            description: Mysql
            id: mysql_wordpress-1
            inputs:
              - type: logfile
                enabled: false
              - type: mysql/metrics
                enabled: false
          - name: redis_wordpress-1
            package:
              name: redis
            description: Redis
            id: redis_wordpress-1
            inputs:
              - type: logfile
                enabled: false
              - type: redis
                enabled: false
              - type: redis/metrics
                enabled: false
              
      - name: Agent Tomcat policy 1
        description: Agent Tomcat policy
        id: agent-tomcat-policy-1
        namespace: default
        monitoring_enabled:
          - logs
          - metrics
        package_policies:
          - name: fleet_server_tomcat-1
            description: Fleet Server
            id: fleet_server_tomcat-1
            package:
              name: fleet_server
          - name: elastic_agent_tomcat-1
            description: Elastic Agent
            id: elastic_agent_tomcat-1
            package:
              name: elastic_agent
          - name: apm_tomcat-1
            description: Elastic APM
            id: apm_tomcat-1
            package:
              name: apm
            inputs:
              - type: apm
                keep_enabled: true
                vars:
                  - name: host
                    value: "0.0.0.0:8200"
                  - name: url
                    value: "http://fleet:8200"
                    # value: "http://fleet.${APP_HOST}.tomcat.local:8200"
          - name: system_tomcat-1
            description: System Integration
            id: system_tomcat-1
            package:
              name: system
            inputs:
              - type: logfile
                enabled: false
                streams:
                  - data_stream:
                      dataset: system.syslog
                    enabled: true
                    vars:
                      - name: paths
                        value:
                          - /hostfs/var/log/messages
                          - /hostfs/var/log/syslog
                  - data_stream:
                      dataset: system.auth
                    enabled: true
                    vars:
                      - name: paths
                        value:
                          - /hostfs/var/log/auth.log
                          - /hostfs/var/log/secure
              - type: system/metrics
                enabled: false
                vars:
                  - name: system.hostfs
                    value: /hostfs
              - type: winlog
                enabled: false
          - name: nginx_tomcat-1
            package:
              name: nginx
            description: Nginx
            id: nginx_tomcat-1
            inputs:
              - type: logfile
                streams:
                  - data_stream:
                      dataset: nginx.access
                    enabled: true
                    vars:
                      - name: paths
                        value:
                          - /usr/share/elastic-agent/data/elastic-agent-${STV}/install/filebeat-${STACK_VERSION}-linux-x86_64/elogs/nginx/tombola/access.log
                          - /usr/share/elastic-agent/data/elastic-agent-${STV}/install/filebeat-${STACK_VERSION}-linux-x86_64/elogs/nginx/tombola/ad.access.log
                          - /usr/share/elastic-agent/data/elastic-agent-${STV}/install/filebeat-${STACK_VERSION}-linux-x86_64/elogs/nginx/tombola/web.access.log
                  - data_stream:
                      dataset: nginx.error
                    enabled: true
                    vars:
                      - name: paths
                        value:
                          - /usr/share/elastic-agent/data/elastic-agent-${STV}/install/filebeat-${STACK_VERSION}-linux-x86_64/elogs/nginx/tombola/error.log
                          - /usr/share/elastic-agent/data/elastic-agent-${STV}/install/filebeat-${STACK_VERSION}-linux-x86_64/elogs/nginx/tombola/ad.error.log
                          - /usr/share/elastic-agent/data/elastic-agent-${STV}/install/filebeat-${STACK_VERSION}-linux-x86_64/elogs/nginx/tombola/web.error.log
              - type: nginx/metrics
                enabled: true
                vars:
                  - name: hosts
                    value:
                      # to existing server:
                      # - http://${APP_HOST}.tomcat.local
                      # to service:
                      - http://webtombola
          - name: postgresql_tomcat-1
            package:
              name: postgresql
            description: Postgresql
            id: postgresql_tomcat-1
            inputs:
              - type: logfile
                enabled: false
              - type: postgresql/metrics
                enabled: false
                # postgres://tombola-db:5432/tombola
          - name: tomcat_tomcat-1
            package:
              name: tomcat
            description: Tomcat
            id: tomcat_tomcat-1
            inputs:
              - type: logfile
                enabled: false
              - type: tcp
                enabled: false
              - type: udp
                enabled: false
              - type: tomcat/metrics
                enabled: false
          - name: redis_tomcat-1
            package:
              name: redis
            description: Redis
            id: redis_tomcat-1
            inputs:
              - type: logfile
                enabled: false
              - type: redis
                enabled: false
              - type: redis/metrics
                enabled: false

# https://www.elastic.co/guide/en/kibana/master/logging-configuration.html                  
logging:
  appenders:
    file:
      type: file
      fileName: /usr/share/kibana/logs/kibana.log
      layout:
        type: pattern
        pattern: "[%date] [%level] [%logger] [%meta] %message"
  root:
    appenders: [default, file]
    level: info
  loggers:
    - name: plugins
      appenders: [default, file]
      level: info
    - name: optimize
      appenders: [default, file]
      level: info
    - name: telemetry
      appenders: [default, file]
      level: info
    - name: metrics.ops
      appenders: [default, file]
      level: info
